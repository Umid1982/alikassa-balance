# Crypto Balance API

REST API –º–æ–¥—É–ª—å —É—á–µ—Ç–∞ –∫—Ä–∏–ø—Ç–æ-–±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –∏ —Å–ø–∏—Å–∞–Ω–∏–µ–º —Å—Ä–µ–¥—Å—Ç–≤.

–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ —Ç–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç production-–ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–±–æ—Ç–µ —Å –¥–µ–Ω–µ–∂–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é –∏ –∑–∞—â–∏—Ç–æ–π –æ—Ç race conditions.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)
- [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏](#-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#-api-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è ‚úÖ

- ‚úÖ –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ (deposit)
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞
- ‚úÖ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞
- ‚úÖ –û—Ç–º–µ–Ω–∞ –≤—ã–≤–æ–¥–∞
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π (idempotency)

### –£—á–µ—Ç —Ä–∏—Å–∫–æ–≤ ‚≠ê

- ‚≠ê –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `external_id`
- ‚≠ê –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions —á–µ—Ä–µ–∑ `DB::transaction` + `lockForUpdate`
- ‚≠ê –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ `amount` –∏ `locked_amount`
- ‚≠ê –¢–æ—á–Ω–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ BCMath (`decimal 36,18`)
- ‚≠ê –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è

---

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **PHP** 8+
- **Laravel**
- **Laravel Sanctum** ‚Äî API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **MySQL / PostgreSQL / SQLite**
- **BCMath** ‚Äî —Ç–æ—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥—Ä–æ–±–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
git clone <repository-url>
cd crypto-balance
composer install
cp .env.example .env
php artisan key:generate
php artisan migrate
php artisan serve
```

---

## üìö API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ë–∞–∑–æ–≤—ã–π URL

```
http://localhost:8000/api
```

---

### üü¢ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞ (webhook received)

```
POST /api/balance/deposit/seen
```

```json
{
  "user_id": 1,
  "currency": "USDT",
  "amount": "100.00",
  "external_id": "tx_hash_123"
}
```

---

### üü¢ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞

```
POST /api/balance/deposit/confirm
```

```json
{
  "external_id": "tx_hash_123"
}
```

---

### üî¥ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞

```
POST /api/balance/withdraw/reserve
```

```json
{
  "user_id": 1,
  "currency": "USDT",
  "amount": "50.00",
  "external_id": "withdraw_001"
}
```

---

### üî¥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞

```
POST /api/balance/withdraw/commit
```

```json
{
  "external_id": "withdraw_001"
}
```

---

### üî¥ –û—Ç–º–µ–Ω–∞ –≤—ã–≤–æ–¥–∞

```
POST /api/balance/withdraw/cancel
```

```json
{
  "external_id": "withdraw_001"
}
```

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

```
app/
‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ Requests/
‚îÇ   ‚îú‚îÄ‚îÄ Resources/
‚îÇ   ‚îî‚îÄ‚îÄ Traits/
‚îú‚îÄ‚îÄ Services/
‚îú‚îÄ‚îÄ Repositories/
‚îú‚îÄ‚îÄ DTOs/
‚îî‚îÄ‚îÄ Models/
```

### –°–ª–æ–∏:

- **Controllers** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ HTTP
- **Services** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
- **Repositories** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –ë–î
- **DTO** ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–ª–∞–Ω—Å–∞

### –¢–∞–±–ª–∏—Ü–∞ `balances`

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| amount | –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å |
| locked_amount | –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ |

---

### –¢–∞–±–ª–∏—Ü–∞ `balance_operations`

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| type | deposit / withdraw |
| status | pending / confirmed / reserved / completed / canceled |
| external_id | –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π –∫–ª—é—á |

---

## üéØ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üîê –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

```php
DB::transaction()
SELECT ... FOR UPDATE
```

—á—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –¥–≤–æ–π–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

---

### üîÅ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ `external_id`.  
–ü–æ–≤—Ç–æ—Ä–Ω—ã–π webhook –Ω–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∑–∞—á–∏—Å–ª–µ–Ω–∏—é –∏–ª–∏ —Å–ø–∏—Å–∞–Ω–∏—é.

---

### üí∞ –ú–æ–¥–µ–ª—å –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤
2. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –≤ `locked_amount`
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∞
4. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## üë§ –ê–≤—Ç–æ—Ä

Umid Urinov  
Backend Developer (Laravel, Financial Systems)

---

## üîÑ –í–µ—Ä—Å–∏—è

v1.0.0 ‚Äî –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–æ–¥—É–ª—å —É—á–µ—Ç–∞ –∫—Ä–∏–ø—Ç–æ-–±–∞–ª–∞–Ω—Å–∞ —Å —É—á–µ—Ç–æ–º —Ä–∏—Å–∫–æ–≤ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏.
